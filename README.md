# Real-Time Fraud Detection System

## Архитектура

Компоненты системы:
1. **`interface`** (Streamlit UI):
   
   Создан для удобной симуляции потоковых данных с транзакциями. Реальный продукт использовал бы прямой поток данных из других систем.
    - Имитирует отправку транзакций в Kafka через CSV-файлы.
    - Генерирует уникальные ID для транзакций.
    - Загружает транзакции отдельными сообщениями формата JSON в топик kafka `transactions`.
    
2. **`fraud_detector`** (ML Service):
   - Загружает предобученную модель CatBoost (`my_catboost.cbm`).
   - Выполняет препроцессинг данных:
     - Извлечение временных признаков
     - Гео-расстояния
     - Кодирование категориальных переменных
   - Производит скоринг с порогом 0.98.
   - Выгружает результат скоринга в топик kafka `scoring`

3. **`db`** (postgre Database):
   - Читает из Kafka-топика `scoring` результаты скоринга и сохраняет их в PostgreSQL-базу данных.
   - Поддерживает вставку батчами (для ускорения) и вставку по таймауту
   - Позволяет обратиться к данным как из терминала, так и через интерфейс `Streamlit UI`

4. **Kafka Infrastructure**:
   - Zookeeper + Kafka брокер
   - `kafka-setup`: автоматически создает топики `transactions` и `scoring`
   - Kafka UI: веб-интерфейс для мониторинга сообщений (порт 8080)

## Запуск

### Требования
- Docker 20.10+
- Docker Compose 2.0+

### Запуск
```bash
git clone https://github.com/your-repo/fraud-detection-system.git
cd fraud-detection-system

docker-compose up --build
```
После запуска:
- **Streamlit UI**: http://localhost:8501
- **Kafka UI**: http://localhost:8080
- **Обращение к базе данных**: 
   ```bash
   docker exec -it postgres_db psql -U ml_user -d ml_scores (в терминале)
- **Логи сервисов**: 
  ```bash
  docker-compose logs <service_name>  # Например: fraud_detector, kafka, interface, db

## Использование

### 1. Загрузка данных:

 - Загрузите CSV через интерфейс Streamlit. Структура csv-файла должна быть, как у файла `test.csv` из соревнования https://www.kaggle.com/competitions/teta-ml-1-2025:

 - Так как инференс модели довольно медленный, не рекомендуется загружать очень большие файлы

### 2. Мониторинг:
 - **Kafka UI**: Просматривайте сообщения в топиках transactions и scoring
 - **postgres**: Обращайтесь к базе данных и получайте информацию о предсказаниях транзакций
 - **Логи обработки**: /app/logs/service.log внутри контейнера fraud_detector

### 3. Результаты:

 - Скоринговые оценки пишутся в топик scoring в формате:
    ```json
    {
    "score": 0.995, 
    "fraud_flag": 1, 
    "transaction_id": "d6b0f7a0-8e1a-4a3c-9b2d-5c8f9d1e2f3a",
    "created_at": "2025-11-08 01:23:57"
    }
    ```
 - Нажав на кнопку `Посмотреть результаты` в Streamlit UI можно получить информацию о 10 последних фродовых транзакциях и увидеть гистограмму последних 100 предсказаний модели

 - Также сервис поддерживает возможность  написать свой sql-запрос прямо в интерфейсе Streamlit, для этого воспользуйтесь специальным окном и следуйте инструкциям

*Примечание:* 

Для полной функциональности убедитесь, что:
1. Модель `my_catboost.cbm` размещена в `fraud_detector/models/`
2. Тренировочные данные находятся в `fraud_detector/train_data/`
3. Порты 8080, 5432, 8501 и 9095 свободны на хосте
